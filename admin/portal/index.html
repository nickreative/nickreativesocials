<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Portal</title>
  <meta name="robots" content="noindex,nofollow" />
  <style>
    body {
      font-family: Helvetica, Arial, sans-serif;
      padding: 24px;
    }
    select {
      margin-bottom: 16px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(4, 120px);
      gap: 12px;
    }
    .grid img {
      width: 100%;
      border: 1px solid #ccc;
    }
    .preview {
      margin-top: 24px;
      max-width: 420px;
    }
    .preview img {
      width: 100%;
      aspect-ratio: 5 / 4;
      object-fit: cover;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>

<h2>Admin â€” Social Previews</h2>

<label>
  Select client:
  <select id="clientSelect">
    <option value="suitecollection">Suite Collection</option>
    <option value="pocky">Pocky</option>
    <option value="vicalates">Vicalates</option>
    <option value="livencommunities">Liven Communities</option>
  </select>
</label>

<div class="grid" id="grid"></div>

<div class="preview" id="preview" hidden>
  <img id="previewImg" />
  <p id="caption"></p>
</div>
<div id="editor" hidden>
  <h3>Edit post</h3>

  <label>
    Slot:
    <select id="slotSelect">
      ${[...Array(12)].map((_, i) => `<option>${i+1}</option>`).join("")}
    </select>
  </label>

  <br><br>

  <label>
    Aspect:
    <select id="aspectSelect">
      <option value="5:4">5:4 (grid / carousel)</option>
      <option value="9:16">9:16 (reel)</option>
    </select>
  </label>

  <br><br>

  <textarea id="captionInput" rows="4" cols="40"></textarea>

  <br><br>

  <button id="saveBtn">Save</button>
</div>

<script type="module">
  import { supabase } from "/assets/js/supabase.js";

  const { data: sessionData } = await supabase.auth.getSession();
  const user = sessionData?.session?.user;

  if (!user || user.user_metadata.role !== "admin") {
    window.location.href = "/admin/login/";
    throw new Error("Not authorised");
  }

async function loadPosts(client) {
  const { data, error } = await supabase
    .from("posts")
    .select("*")
    .eq("client", client)
    .order("slot");

  if (error) {
    alert("Failed to load posts");
    console.error(error);
    return [];
  }

  return data;
}


  const grid = document.getElementById("grid");
  const preview = document.getElementById("preview");
  const previewImg = document.getElementById("previewImg");
  const captionEl = document.getElementById("caption");
  const clientSelect = document.getElementById("clientSelect");

  const editor = document.getElementById("editor");
  const slotSelect = document.getElementById("slotSelect");
  const aspectSelect = document.getElementById("aspectSelect");
  const captionInput = document.getElementById("captionInput");
  const saveBtn = document.getElementById("saveBtn");

  let currentClient = clientSelect.value;
  let currentPost = null;

  async function render(client) {
    grid.innerHTML = "";
    preview.hidden = true;
    editor.hidden = true;

    const posts = await loadPosts(client);

    const slots = Array.from({ length: 12 }, (_, i) => i + 1);

slots.forEach(slot => {
  const post = posts.find(p => p.slot === slot);

  const img = document.createElement("img");

  img.src = post
    ? `https://via.placeholder.com/300x240?text=Slot+${slot}`
    : `https://via.placeholder.com/300x240?text=Empty+${slot}`;

  img.onclick = () => {
    currentPost = post || { client, slot };

    preview.hidden = false;
    previewImg.src = img.src;
    captionEl.textContent = post?.caption || "";

    editor.hidden = false;
    slotSelect.value = slot;
    aspectSelect.value = post?.aspect || "5:4";
    captionInput.value = post?.caption || "";
  };

  grid.appendChild(img);
});

  }

  clientSelect.onchange = () => {
    currentClient = clientSelect.value;
    render(currentClient);
  };

  saveBtn.onclick = async () => {
    if (!currentPost) return;

    const updates = {
      slot: Number(slotSelect.value),
      aspect: aspectSelect.value,
      caption: captionInput.value
    };

let response;

if (currentPost.id) {
  response = await supabase
    .from("posts")
    .update(updates)
    .eq("id", currentPost.id);
} else {
  response = await supabase
    .from("posts")
    .insert({
      client: currentClient,
      slot: currentPost.slot,
      ...updates
    });
}

if (response.error) {
  alert("Save failed");
  console.error(response.error);
} else {
  render(currentClient);
}


    if (error) {
      alert("Save failed");
      console.error(error);
    } else {
      render(currentClient);
    }
  };

  render(currentClient);


  
</script>

</body>
</html>
