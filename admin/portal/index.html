<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Portal</title>
  <meta name="robots" content="noindex,nofollow" />
  <style>
    body {
      font-family: Helvetica, Arial, sans-serif;
      padding: 24px;
    }
    select {
      margin-bottom: 16px;
    }
.grid {
  display: grid;
  grid-template-columns: repeat(3, 120px);
  grid-template-rows: repeat(4, 150px); /* 5:4 vertical */
  gap: 6px;
}
.grid img {
  width: 100%;
  height: 100%;
  object-fit: cover;   /* enforces crop */
  aspect-ratio: 5 / 4;
  border: 1px solid #ccc;
  cursor: pointer;
}

    .preview {
      margin-top: 24px;
      max-width: 630px;
    }
    .preview img {
      width: 100%;
      aspect-ratio: 5 / 4;
      object-fit: cover;
      border: 1px solid #ccc;
    }
    .carousel {
  width: 100%;
  aspect-ratio: 4 / 5;
  position: relative;
  overflow: hidden;
  border: 1px solid #ccc;
}

.carousel img,
.carousel video {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.carousel .active {
  opacity: 1;
  position: relative;
}
    .carousel-controls {
  display: flex;
  gap: 12px;
  margin-top: 8px;
}

    
.layout {
  display: grid;
  grid-template-columns: auto 520px;
  gap: 32px;
  align-items: start;
}
.preview {
  height: auto;
}

.carousel {
  height: auto;
}


  </style>
</head>
<body>

<h2>Admin — Social Previews</h2>

<label>
  Select client:
  <select id="clientSelect">
    <option value="suitecollection">Suite Collection</option>
    <option value="pocky">Pocky</option>
    <option value="vicalates">Vicalates</option>
    <option value="livencommunities">Liven Communities</option>
  </select>
</label>

<div class="layout">
  <div class="grid" id="grid"></div>

  <div class="preview" id="preview" hidden>
    <div id="carousel" class="carousel"></div>

    <div class="carousel-controls">
      <button id="prevSlide">←</button>
      <button id="nextSlide">→</button>
    </div>

    <p id="caption"></p>
  </div>
</div>


  <p id="caption"></p>
</div>

<div id="editor" hidden>
  <h3>Edit post</h3>


  <br><br>

  <label>
    Aspect:
    <select id="aspectSelect">
      <option value="5:4">5:4 (grid / carousel)</option>
      <option value="9:16">9:16 (reel)</option>
    </select>
  </label>

  <br><br>

  <textarea id="captionInput" rows="4" cols="40"></textarea>

  <br><br>
<hr>

<label>
  Thumbnail:
  <input type="file" id="thumbInput" accept="image/*">
</label>

<br><br>

<label>
  Media (images / videos):
  <input type="file" id="mediaInput" accept="image/*,video/*" multiple>
</label>

<br><br>

  <button id="saveBtn">Save</button>
</div>

<script type="module">
import { supabase } from "/assets/js/supabase.js";

/* ---------- AUTH ---------- */
const { data: sessionData } = await supabase.auth.getSession();
const user = sessionData?.session?.user;

if (!user || user.user_metadata.role !== "admin") {
  window.location.href = "/admin/login/";
  throw new Error("Not authorised");
}

/* ---------- DOM ---------- */
const grid = document.getElementById("grid");
const preview = document.getElementById("preview");
const carousel = document.getElementById("carousel");
const captionEl = document.getElementById("caption");

const clientSelect = document.getElementById("clientSelect");
const aspectSelect = document.getElementById("aspectSelect");
const captionInput = document.getElementById("captionInput");
const saveBtn = document.getElementById("saveBtn");
const editor = document.getElementById("editor");

const thumbInput = document.getElementById("thumbInput");
const mediaInput = document.getElementById("mediaInput");

const prevBtn = document.getElementById("prevSlide");
const nextBtn = document.getElementById("nextSlide");

/* ---------- STATE ---------- */
let currentClient = clientSelect.value;
let currentPost = null;
let slides = [];
let currentSlideIndex = 0;

/* ---------- HELPERS ---------- */
async function loadPosts(client) {
  const { data, error } = await supabase
    .from("posts")
    .select("*")
    .eq("client", client)
    .order("slot");

  if (error) {
    console.error(error);
    return [];
  }

  return data;
}

async function uploadFile(path, file) {
  const { error } = await supabase.storage
    .from("social-media")
    .upload(path, file, { upsert: true });

  if (error) throw error;

  return supabase.storage
    .from("social-media")
    .getPublicUrl(path).data.publicUrl;
}

function showSlide(index) {
  slides.forEach((el, i) => {
    el.classList.toggle("active", i === index);
  });
}

/* ---------- GRID RENDER ---------- */
async function render(client) {
  grid.innerHTML = "";
  preview.hidden = true;
  editor.hidden = true;

  const posts = await loadPosts(client);
  const slots = Array.from({ length: 12 }, (_, i) => i + 1);

  slots.forEach(slot => {
    const post = posts.find(p => p.slot === slot);

    const img = document.createElement("img");
    img.src = post?.thumbnail_url || "/assets/empty.png";

    img.onclick = () => {
      carousel.innerHTML = "";
slides = [];
currentSlideIndex = 0;

      currentPost = {
        id: post?.id || null,
        client: currentClient,
        slot: slot
      };

      preview.hidden = false;
      editor.hidden = false;

      /* Build carousel */
      carousel.innerHTML = "";
      slides = [];
      currentSlideIndex = 0;

      (post?.media_urls || []).forEach((url, i) => {
        let el;

        if (url.endsWith(".webm") || url.endsWith(".mp4")) {
          el = document.createElement("video");
          el.src = url;
          el.muted = true;
          el.playsInline = true;
          el.loop = true;
          el.autoplay = true;
        } else {
          el = document.createElement("img");
          el.src = url;
        }

        if (i === 0) el.classList.add("active");
        carousel.appendChild(el);
        slides.push(el);
      });
      carousel.style.aspectRatio =
  post?.aspect === "9:16" ? "9 / 16" : "4 / 5";

carousel.style.maxHeight =
  post?.aspect === "9:16" ? "1344px" : "630px";


      captionInput.value = post?.caption || "";
      aspectSelect.value = post?.aspect || "5:4";
      captionEl.textContent = post?.caption || "";
    };

    grid.appendChild(img);
  });
}

/* ---------- NAV ---------- */
prevBtn.onclick = () => {
  if (!slides.length) return;
  currentSlideIndex =
    (currentSlideIndex - 1 + slides.length) % slides.length;
  showSlide(currentSlideIndex);
};

nextBtn.onclick = () => {
  if (!slides.length) return;
  currentSlideIndex =
    (currentSlideIndex + 1) % slides.length;
  showSlide(currentSlideIndex);
};

/* ---------- SAVE ---------- */
saveBtn.onclick = async () => {
  if (!currentPost) return;

  let thumbnailUrl = null;
  let mediaUrls = null;

if (thumbInput.files[0]) {
  thumbnailUrl =
    (await uploadFile(
      `${currentPost.client}/slot-${currentPost.slot}/thumb.jpg`,
      thumbInput.files[0]
    )) + `?v=${Date.now()}`;
}


if (mediaInput.files.length) {
  mediaUrls = [];

  for (let i = 0; i < mediaInput.files.length; i++) {
    const file = mediaInput.files[i];
    const ext = file.name.split(".").pop();

    const url = await uploadFile(
      `${currentPost.client}/slot-${currentPost.slot}/${String(i + 1).padStart(2, "0")}.${ext}`,
      file
    );

    mediaUrls.push(url + `?v=${Date.now()}`);
  }
}

const payload = {
  client: currentPost.client,
  slot: currentPost.slot,
  caption: captionInput.value,
  aspect: aspectSelect.value,
  ...(thumbnailUrl && { thumbnail_url: thumbnailUrl }),
  ...(mediaUrls && { media_urls: mediaUrls })
};



  let result;

  if (currentPost.id) {
    result = await supabase
      .from("posts")
      .update(payload)
      .eq("id", currentPost.id);
  } else {
    result = await supabase
      .from("posts")
      .insert(payload);
  }

  if (result.error) {
    alert("Save failed");
    console.error(result.error);
    return;
  }

  render(currentClient);
};

/* ---------- INIT ---------- */
clientSelect.onchange = () => {
  currentClient = clientSelect.value;
  render(currentClient);
};

render(currentClient);
</script>



</body>
</html>
