<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Client Portal</title>
  <meta name="robots" content="noindex,nofollow" />
  <style>
body {
font-family: Helvetica, Arial, sans-serif;
padding: 24px;
}

/* ---------- Layout ---------- */
.layout {
display: grid;
grid-template-columns: max-content 520px;
gap: 32px;
align-items: start;
}

/* ---------- Grid ---------- */
.grid {
display: grid;
width: fit-content;
grid-template-columns: repeat(3, 120px);
grid-template-rows: repeat(4, 150px); /* 5:4 vertical */
gap: 6px;
}

.grid img {
width: 100%;
height: 100%;
object-fit: cover;
border: 1px solid #ccc;
cursor: pointer;
}

/* ---------- Preview ---------- */
.preview {
width: 520px;
}

.carousel {
  position: relative;
  width: 100%;
  aspect-ratio: 4 / 5;   /* PORTRAIT */
  overflow: hidden;
  border: 1px solid #ccc;
}


.carousel img,
.carousel video {
position: absolute;
inset: 0;
width: 100%;
height: 100%;
object-fit: cover;
opacity: 0;
transition: opacity 0.3s ease;
}

.carousel .active {
opacity: 1;
position: relative;
}

.carousel-controls {
margin: 8px 0;
}

.preview img,
.preview video {
width: 100%;
aspect-ratio: 4 / 5;
object-fit: cover;
}

    .preview {
  height: auto;
}

.carousel {
  height: auto;
}


/* ---------- Actions ---------- */
.actions {
margin-top: 12px;
}
</style>
</head>
<body>

<h2 id="clientHeading"></h2>

<div class="layout">
  <div class="grid" id="grid"></div>

  <div class="preview" id="preview" hidden>
    <div id="carousel" class="carousel"></div>

    <div class="carousel-controls">
      <button id="prevBtn">←</button>
      <button id="nextBtn">→</button>
    </div>

    <p id="caption"></p>

    <div class="actions">
      <button id="approveBtn">Approve</button>
      <button id="changesBtn">Request changes</button>
    </div>
  </div>
</div>


<script type="module">
  import { supabase } from "/assets/js/supabase.js";

  const { data: sessionData } = await supabase.auth.getSession();
  const user = sessionData?.session?.user;

  if (!user || user.user_metadata.role !== "client") {
    window.location.href = "/login/";
    throw new Error("Not authorised");
  }

  const client = user.user_metadata.client;
  document.getElementById("clientHeading").textContent =
    `Social previews — ${client}`;

 const { data: posts, error } = await supabase
  .from("posts")
  .select("*")
  .eq("client", client)
  .order("slot");

if (error) {
  alert("Failed to load posts");
  console.error(error);
}


const grid = document.getElementById("grid");
const preview = document.getElementById("preview");
const carousel = document.getElementById("carousel");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const captionEl = document.getElementById("caption");

let slides = [];
let currentSlide = 0;
let currentPost = null;


function renderCarousel(post) {
  carousel.innerHTML = "";
  slides = [];
  currentSlide = 0;

  if (!post.media_urls || !post.media_urls.length) return;

  post.media_urls.forEach((url, index) => {
    let el;

    if (url.endsWith(".mp4") || url.endsWith(".webm")) {
      el = document.createElement("video");
      el.src = url;
      el.muted = true;
      el.loop = true;
      el.playsInline = true;
      el.autoplay = true;
    } else {
      el = document.createElement("img");
      el.src = url;
    }

    if (index === 0) el.classList.add("active");

    carousel.appendChild(el);
    slides.push(el);
  });

  carousel.style.aspectRatio =
    post.aspect === "9:16" ? "9 / 16" : "5 / 4";
  carousel.style.maxHeight =
  post.aspect === "9:16" ? "720px" : "630px";

}

function showSlide(index) {
  slides.forEach((el, i) => {
    el.classList.toggle("active", i === index);
    if (el.tagName === "VIDEO") {
      i === index ? el.play() : el.pause();
    }
  });
}

prevBtn.onclick = () => {
  if (!slides.length) return;
  currentSlide = (currentSlide - 1 + slides.length) % slides.length;
  showSlide(currentSlide);
};

nextBtn.onclick = () => {
  if (!slides.length) return;
  currentSlide = (currentSlide + 1) % slides.length;
  showSlide(currentSlide);
};

posts.forEach(post => {
  if (!post) return;

  const img = document.createElement("img");
  img.src = post.thumbnail_url || "/assets/empty.png";

  img.addEventListener("click", () => {
    preview.hidden = false;
    renderCarousel(post);
    captionEl.textContent = post.caption || "";
    currentPost = post;
  });

  grid.appendChild(img);
});



  function openMail(subject) {
    if (!currentPost) return;
    const body = encodeURIComponent(
      `Hi Nick,\n\n${subject}:\nPost ${currentPost.id}\n`
    );
    window.location.href =
      `mailto:nick@nickreative.com?subject=Social feedback&body=${body}`;
  }

  document.getElementById("approveBtn").onclick =
    () => openMail("I approve the following posts");

  document.getElementById("changesBtn").onclick =
    () => openMail("Could you make changes to the following posts");
</script>

</body>
</html>
